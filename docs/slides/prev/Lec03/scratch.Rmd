




## Model fit

```{r echo=FALSE}
poisson_model_quad = 
"model{
# Likelihood
for(i in 1:length(Y)){
Y[i] ~ dpois(lambda[i])
log(lambda[i]) <- beta[1] + beta[2]*(X[i] - 1981) + beta[3]*(X[i] - 1981)^2

# In-sample prediction
Y_hat[i] ~ dpois(lambda[i])
}

# Prior for beta
for(j in 1:3){
beta[j] ~ dnorm(0,1/100)
}
}"

m_quad = jags.model(
textConnection(poisson_model_quad), quiet = TRUE,
data = list(Y=aids$cases, X=aids$year)
) 
update(m_quad, n.iter=1000, progress.bar="none")
samp_quad = coda.samples(
m_quad, variable.names=c("beta","lambda","Y_hat"), 
n.iter=5000, progress.bar="none"
)

y_hat_quad = get_coda_parameter(samp_quad, "Y_hat")
aids_bpred_quad = cbind(
aids,
post_summary(y_hat_quad)
)

aids_quad = aids_base +
geom_ribbon(data=aids_bpred_quad, aes(ymin = post_lower, ymax = post_upper), fill='blue', alpha=0.3) +
geom_line(data=aids_bpred_quad, aes(y = post_mean), color='red') +
labs(subtitle="(Quadratic Poisson Model)")

print(aids_quad)
```

## Bayesian Residual Plots

```{r echo=FALSE, out.width="\\textwidth"}
lambda_quad = get_coda_parameter(samp_quad, "lambda")

standard = post_summary( apply(lambda_quad, 1, pois_standard_resid, y=aids$cases) %>% t() )
pearson  = post_summary( apply(lambda_quad, 1, pois_pearson_resid , y=aids$cases) %>% t() )
deviance = post_summary( apply(lambda_quad, 1, pois_deviance_resid, y=aids$cases) %>% t() )

aids_bresid_quad = rbind(
cbind(aids, type="standard", standard),
cbind(aids, type="pearson",  pearson),
cbind(aids, type="deviance", deviance)
)

ggplot(aids_bresid_quad, aes(x=year, y=post_mean, color=type)) +
geom_point() + 
geom_segment(aes(x=year, xend=year, y=post_lower, yend=post_upper)) +
facet_wrap(~type, ncol=3, scale="free_y") + 
guides(color=FALSE) + 
geom_point(data=aids_resid2, aes(x=year, y=residual), color="black", alpha=0.2)
```

# Negative Binomial Regression

## Overdispersion

One of the properties of the Poisson distribution is that if $X \sim \text{Pois}(\lambda)$ then $E(X) = Var(X) = \lambda$. 

If we are constructing a model where we claim that our response variable $Y$ follows a Poisson distribution then we are making a very strong assumption which has implactions for both inference and prediction.

. . . 

```{r}
mean(aids$cases)
var(aids$cases)
```

## Negative binomial regession

If we define

$$
\begin{aligned}
Y_i|Z_i &\sim \text{Pois}(\lambda_i \; Z_i) \\
Z_i &\sim \text{Gamma}(\theta_i, \, \theta_i)
\end{aligned}
$$

then the marginal distribution of $Y_i$ will be negative binomial with,

$$
\begin{aligned}
E(Y_i)   &= \lambda_i \\
Var(Y_i) &= \lambda_i + \lambda_i^2/\theta_i
\end{aligned}
$$

## Model 

```{r echo=FALSE}
negbin_model = 
"model{
for(i in 1:length(Y))
{
  Z[i] ~ dgamma(theta, theta)
  log(lambda[i]) <- beta[1] + beta[2]*(X[i] - 1981) + beta[3]*(X[i] - 1981)^2
  
  lambda_Z[i] <- Z[i]*lambda[i]
  
  Y[i] ~ dpois(lambda_Z[i])
  Y_hat[i] ~ dpois(lambda_Z[i])
}

for(j in 1:3){
beta[j] ~ dnorm(0, 1/100)
}

log_theta ~ dnorm(0, 1/100)
theta <- exp(log_theta)
}"

cat(negbin_model,"\n")
```


## Negative Binomial Model fit

```{r echo=FALSE}
m_nb = jags.model(
textConnection(negbin_model), quiet = TRUE,
data = list(Y=aids$cases, X=aids$year)
) 
update(m_nb, n.iter=1000, progress.bar="none")
samp_nb = coda.samples(
m_nb, variable.names=c("beta","lambda","Y_hat","Z"), 
n.iter=5000, progress.bar="none"
)

y_hat_nb = get_coda_parameter(samp_nb, "Y_hat")
aids_bpred_nb = cbind(
aids,
post_summary(y_hat_nb)
)

aids_nb = aids_base +
geom_ribbon(data=aids_bpred_nb, aes(ymin = post_lower, ymax = post_upper), fill='blue', alpha=0.3) +
geom_line(data=aids_bpred_nb, aes(y = post_mean), color='red') + 
labs(subtitle="(Quadratic Negative Binomial Model)")

grid.arrange(aids_quad, aids_nb, ncol=2)
x=get_coda_parameter(samp_nb, "Z")
```

## Bayesian Residual Plots

```{r echo=FALSE, out.width="\\textwidth"}
lambda_nb = get_coda_parameter(samp_nb, "lambda")

standard = post_summary( apply(lambda_nb, 1, pois_standard_resid, y=aids$cases) %>% t() )
pearson  = post_summary( apply(lambda_nb, 1, pois_pearson_resid , y=aids$cases) %>% t() )
#deviance = post_summary( apply(y_hat_quad, 1, pois_deviance_resid, y=aids$cases) %>% t() )

aids_bresid_nb = rbind(
cbind(aids, type="standard", standard),
cbind(aids, type="pearson",  pearson)
#cbind(aids, type="deviance", deviance)
)

ggplot(aids_bresid_nb, aes(x=year, y=post_mean, color=type)) +
geom_point() + 
geom_segment(aes(x=year, xend=year, y=post_lower, yend=post_upper)) +
facet_wrap(~type, ncol=3, scale="free_y") + 
guides(color=FALSE)
```





